<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <property name="now" value="now()" dbms="mysql,h2"/>
    <property name="now" value="current_timestamp" dbms="postgresql"/>
    <property name="now" value="sysdate" dbms="oracle"/>

    <property name="autoIncrement" value="true" dbms="mysql,h2,postgresql"/>
    <property name="autoIncrement" value="false" dbms="oracle"/>
    <!--
        Added the entity MESSAGES.
    -->
    <changeSet id="20160914042700" author="jhipster">
        <createTable tableName="MESSAGES">
            <column name="id" type="bigint" autoIncrement="${autoIncrement}" >
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="from_user_id" type="bigint">
				<constraints nullable="false" />
			</column>            
            <column name="message_subject" type="varchar(255)"/>
  			<column name="message_datetime" type="timestamp" defaultValueDate="${now}">
				<constraints nullable="false" />
			</column>
 			<column name="message_size_MBs" type="bigint"/>
			<column name="message_type" type="varchar(255)"/>
			<column name="to_message_id" type="bigint"/>
			<column name="root_message_id" type="bigint"/>
			<column name="message_text" type="longtext"/>
        </createTable>
        
        <addForeignKeyConstraint baseColumnNames="from_user_id"
                                 baseTableName="MESSAGES"
                                 constraintName="fk_ms_from_user_id"
                                 referencedColumnNames="id"
                                 referencedTableName="USER"/>
                                 
        <addForeignKeyConstraint baseColumnNames="to_message_id"
                                 baseTableName="MESSAGES"
                                 constraintName="fk_ms_to_message_id"
                                 referencedColumnNames="id"
                                 referencedTableName="MESSAGES"/>   
                                 
        <addForeignKeyConstraint baseColumnNames="root_message_id"
                                 baseTableName="MESSAGES"
                                 constraintName="fk_ms_root_message_id"
                                 referencedColumnNames="id"
                                 referencedTableName="MESSAGES"/>                                                   
                      
        <createTable tableName="MESSAGE_TOUSER_ASSOC">
            <column name="id" type="bigint" autoIncrement="${autoIncrement}" >
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="to_user_id" type="bigint">
				<constraints nullable="false" />
			</column>    
			<column name="to_message_id" type="bigint"/>
        </createTable>
                                
 

        <addForeignKeyConstraint baseColumnNames="to_user_id"
                                 baseTableName="MESSAGE_TOUSER_ASSOC"
                                 constraintName="fk_mta_to_user_id"
                                 referencedColumnNames="id"
                                 referencedTableName="USER"/>
                                 
        <addForeignKeyConstraint baseColumnNames="to_message_id"
                                 baseTableName="MESSAGE_TOUSER_ASSOC"
                                 constraintName="fk_mta_to_message_id"
                                 referencedColumnNames="id"
                                 referencedTableName="MESSAGES"/>  
        
        
        <createTable tableName="MESSAGE_ATTACHMENT_ASSOC">
            <column name="id" type="bigint" autoIncrement="${autoIncrement}" >
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="message_id" type="bigint">
				<constraints nullable="false" />
			</column>  
            <column name="attachment_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="attachment_path" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>


        <addForeignKeyConstraint baseColumnNames="message_id"
                                 baseTableName="MESSAGE_ATTACHMENT_ASSOC"
                                 constraintName="fk_ma_message_id"
                                 referencedColumnNames="id"
                                 referencedTableName="MESSAGES"/>


        
    </changeSet>
</databaseChangeLog>
